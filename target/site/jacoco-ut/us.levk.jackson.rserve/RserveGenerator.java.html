<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RserveGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rserve-jackson-format</a> &gt; <a href="index.source.html" class="el_package">us.levk.jackson.rserve</a> &gt; <span class="el_source">RserveGenerator.java</span></div><h1>RserveGenerator.java</h1><pre class="source lang-java linenums">/*
 * The MIT License (MIT)
 * Copyright (c) 2017 lev.v.kuznetsov@gmail.com
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the &quot;Software&quot;), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
package us.levk.jackson.rserve;

import static java.lang.System.arraycopy;

import java.io.IOException;
import java.io.OutputStream;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.List;
import java.util.Stack;

import org.rosuda.REngine.REXP;
import org.rosuda.REngine.REXPDouble;
import org.rosuda.REngine.REXPGenericVector;
import org.rosuda.REngine.REXPInteger;
import org.rosuda.REngine.REXPLogical;
import org.rosuda.REngine.REXPMismatchException;
import org.rosuda.REngine.REXPNull;
import org.rosuda.REngine.REXPString;
import org.rosuda.REngine.RList;
import org.rosuda.REngine.Rserve.protocol.REXPFactory;

import com.fasterxml.jackson.core.Base64Variant;
import com.fasterxml.jackson.core.ObjectCodec;
import com.fasterxml.jackson.core.base.GeneratorBase;
import com.fasterxml.jackson.core.json.JsonWriteContext;

/**
 * Rserve protocol generator
 * 
 * @author levk
 */
public class RserveGenerator extends GeneratorBase {

  /**
   * Unnamed list type frame
   * 
   * @author levk
   */
<span class="fc" id="L66">  private static class Frame {</span>
<span class="fc" id="L67">    List &lt;REXP&gt; values = new ArrayList &lt;&gt; ();</span>
  }

  /**
   * Named list type frame
   * 
   * @author levk
   */
<span class="fc" id="L75">  private static class NamedFrame extends Frame {</span>
<span class="fc" id="L76">    List &lt;String&gt; names = new ArrayList &lt;&gt; ();</span>
  }

  /**
   * Output stream
   */
  private final OutputStream out;
  /**
   * Context stack
   */
<span class="pc" id="L86">  private final Stack &lt;Frame&gt; stack = new Stack &lt;&gt; ();</span>

  /**
   * @param features
   * @param codec
   */
  public RserveGenerator (int features, ObjectCodec codec, OutputStream out) {
<span class="fc" id="L93">    super (features, codec);</span>
<span class="fc" id="L94">    this.out = out;</span>
<span class="fc" id="L95">  }</span>

  /**
   * @param features
   * @param codec
   * @param ctxt
   */
  protected RserveGenerator (int features, ObjectCodec codec, JsonWriteContext ctxt, OutputStream out) {
<span class="nc" id="L103">    super (features, codec, ctxt);</span>
<span class="nc" id="L104">    this.out = out;</span>
<span class="nc" id="L105">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.base.GeneratorBase#_releaseBuffers()
   */
  @Override
<span class="nc" id="L113">  protected void _releaseBuffers () {}</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * com.fasterxml.jackson.core.base.GeneratorBase#_verifyValueWrite(java.lang.
   * String)
   */
  @Override
<span class="nc" id="L123">  protected void _verifyValueWrite (String arg0) throws IOException {}</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.base.GeneratorBase#flush()
   */
  @Override
  public void flush () throws IOException {
<span class="nc" id="L132">    out.flush ();</span>
<span class="nc" id="L133">  }</span>

  /**
   * @param e
   *          expression to write
   * @throws IOException
   */
  private void writeRexp (REXP e) throws IOException {
<span class="fc bfc" id="L141" title="All 2 branches covered.">    if (!stack.isEmpty ()) stack.peek ().values.add (e);</span>
    else try {
<span class="fc" id="L143">      REXPFactory f = new REXPFactory (e);</span>
<span class="fc" id="L144">      byte[] b = new byte[f.getBinaryLength ()];</span>
<span class="fc" id="L145">      f.getBinaryRepresentation (b, 0);</span>
<span class="fc" id="L146">      out.write (b);</span>
<span class="nc" id="L147">    } catch (REXPMismatchException x) {</span>
<span class="nc" id="L148">      throw new IOException (&quot;Unable to write &quot; + e.toDebugString (), x);</span>
<span class="fc" id="L149">    }</span>
<span class="fc" id="L150">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * com.fasterxml.jackson.core.JsonGenerator#writeBinary(com.fasterxml.jackson.
   * core.Base64Variant, byte[], int, int)
   */
  @Override
  public void writeBinary (Base64Variant arg0, byte[] arg1, int arg2, int arg3) throws IOException {
<span class="nc" id="L161">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeBoolean(boolean)
   */
  @Override
  public void writeBoolean (boolean v) throws IOException {
<span class="fc" id="L171">    writeRexp (new REXPLogical (v));</span>
<span class="fc" id="L172">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeEndArray()
   */
  @Override
  public void writeEndArray () throws IOException {
<span class="fc" id="L181">    writeRexp (new REXPGenericVector (new RList (stack.pop ().values)));</span>
<span class="fc" id="L182">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeEndObject()
   */
  @Override
  public void writeEndObject () throws IOException {
<span class="fc" id="L191">    NamedFrame f = (NamedFrame) stack.pop ();</span>
<span class="fc" id="L192">    writeRexp (new REXPGenericVector (new RList (f.values, f.names)));</span>
<span class="fc" id="L193">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * com.fasterxml.jackson.core.JsonGenerator#writeFieldName(java.lang.String)
   */
  @Override
  public void writeFieldName (String n) throws IOException {
<span class="fc" id="L203">    ((NamedFrame) stack.peek ()).names.add (n);</span>
<span class="fc" id="L204">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNull()
   */
  @Override
  public void writeNull () throws IOException {
<span class="nc" id="L213">    writeRexp (new REXPNull ());</span>
<span class="nc" id="L214">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNumber(int)
   */
  @Override
  public void writeNumber (int v) throws IOException {
<span class="fc" id="L223">    writeRexp (new REXPInteger (v));</span>
<span class="fc" id="L224">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNumber(long)
   */
  @Override
  public void writeNumber (long arg0) throws IOException {
<span class="nc" id="L233">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * com.fasterxml.jackson.core.JsonGenerator#writeNumber(java.math.BigInteger)
   */
  @Override
  public void writeNumber (BigInteger arg0) throws IOException {
<span class="nc" id="L244">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNumber(double)
   */
  @Override
  public void writeNumber (double v) throws IOException {
<span class="fc" id="L254">    writeRexp (new REXPDouble (v));</span>
<span class="fc" id="L255">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNumber(float)
   */
  @Override
  public void writeNumber (float v) throws IOException {
<span class="fc" id="L264">    writeNumber ((double) v);</span>
<span class="fc" id="L265">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * com.fasterxml.jackson.core.JsonGenerator#writeNumber(java.math.BigDecimal)
   */
  @Override
  public void writeNumber (BigDecimal arg0) throws IOException {
<span class="nc" id="L275">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeNumber(java.lang.String)
   */
  @Override
  public void writeNumber (String arg0) throws IOException {
<span class="nc" id="L285">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeRaw(java.lang.String)
   */
  @Override
  public void writeRaw (String arg0) throws IOException {
<span class="nc" id="L295">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeRaw(char)
   */
  @Override
  public void writeRaw (char arg0) throws IOException {
<span class="nc" id="L305">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeRaw(java.lang.String,
   * int, int)
   */
  @Override
  public void writeRaw (String arg0, int arg1, int arg2) throws IOException {
<span class="nc" id="L316">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeRaw(char[], int, int)
   */
  @Override
  public void writeRaw (char[] arg0, int arg1, int arg2) throws IOException {
<span class="nc" id="L326">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeRawUTF8String(byte[],
   * int, int)
   */
  @Override
  public void writeRawUTF8String (byte[] arg0, int arg1, int arg2) throws IOException {
<span class="nc" id="L337">    throw new UnsupportedOperationException ();</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeStartArray()
   */
  @Override
  public void writeStartArray () throws IOException {
<span class="fc" id="L347">    stack.push (new Frame ());</span>
<span class="fc" id="L348">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeStartObject()
   */
  @Override
  public void writeStartObject () throws IOException {
<span class="fc" id="L357">    stack.push (new NamedFrame ());</span>
<span class="fc" id="L358">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeString(java.lang.String)
   */
  @Override
  public void writeString (String v) throws IOException {
<span class="fc" id="L367">    writeRexp (new REXPString (v));</span>
<span class="fc" id="L368">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeString(char[], int, int)
   */
  @Override
  public void writeString (char[] v, int o, int s) throws IOException {
<span class="nc" id="L377">    writeString (new String (v, o, s));</span>
<span class="nc" id="L378">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see com.fasterxml.jackson.core.JsonGenerator#writeUTF8String(byte[], int,
   * int)
   */
  @Override
  public void writeUTF8String (byte[] v, int o, int s) throws IOException {
<span class="nc" id="L388">    byte[] t = new byte[s];</span>
<span class="nc" id="L389">    arraycopy (v, o, t, 0, s);</span>
<span class="nc" id="L390">    writeString (new String (t, &quot;UTF-8&quot;));</span>
<span class="nc" id="L391">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>